08-38-12
Запустил контейнер с изоляцией ядер параметром ядра isolcpu=1,2
на моё удивление работали не все ядра, как оказалось этот параметр просто отключает
балансировку нагрузки с данных ядер, такой метод не является очень хорошим.
База запускается на ядре 0 и даже при высокой нагрузке не выходит за его пределы.
Однако тест показывает лучшую производительность при такой конфигурации, что является странным.
По всей видимости монопольное владение одним ядром хорошо сказывается на БД, но таким образом
она не отмасштабируется.
Тротлинг и смена ядер для процессов при такой конфигурации отсутствует полностью
21:13
можно заметить на скрине: Screenshot_20230610_211325
начальную половинную загрузку процессора тёмно-синими полосами
Когда производительность начинает снижаться - то тёмно-синие полосы занимают уже
под 100% процессор: Screenshot_20230610_211425
Когда включён планировщик и ядра отданы монопольно поду - то всё-равно производительность низкая
Может оказаться что ещё некоторые процессы kubernetes запускаются на выделенных ядрах, так как
его cgroup не входит в общую system.slice
В такой конфигурации присутствует тротлинг и смена процессорных ядер для процессов.
21:33
Поставил для групп kubepods-best ограничения с помощью командной строки
в начале не тротлит
количество tps падает с каждым выводом
всё-таки немного тротлит
время ответа снова становится диким. может это даже не проблема cpu,
а в памяти беда
Когда процессор уходит под завязку то процесс начинает тротлить
по всей видимости cfs квоты следят за ним и при такой конфигурации, можно
попробовать их отключить.
время ответа улетает в космос
общая производительность даже хуже в итоге
по отчётам ничего особо не изменилось
21:47
нашёл программу балансировки irq запросов
https://manpages.ubuntu.com/manpages/focal/man1/irqbalance.1.html
есть возможность банить процессорные ядра при обработке irq
сравнить с изоляцией и проверить потом
21:52
переключил режим ядра
включил обратно isolcpu
21:55
нода перезапущена
22:00
старт теста
22:00
забыл перезаписать загрузчик
22:03
перезапуск
22:06
запуск с параметром isolcpu
Бд работает на выделенном ей ядре процесс не тротлится, но загрузка
в сотку убивает производительность
вообще в ноль ушатывает
в сотку грузит. Я не представляю почему он до этого нормально работал
и даже работал лучше
надо провести ещё один тест
22:19
запустил тест без слежения и оно работает лучше намного
по всей видимости большое количество счётчиков оказывало влияние
при чём до сотки почти не доходит
но всё же при упоре в сотку производительность падает
22:28
запуск с профайлингом снова
да, по ощущениям проц забивается снова и производительность падает на забиве
22:30
запуск с меньшим количеством клиентов в 400
так по ощущениям проц не забивается в упор
просадок по tps не наблюдалось
22:42
отключаю параметр isolcpu
11/06
12:04
запуск без отслеживания на те же 80 без изоляции
только на cpuset
даже без слежки сразу влетает в тротлинг
оба ядра оказываются загруженными на 100 процентов
тротлится он по cfs и даже когда ещё не 100 процентов
даже так наблюдается небольшое увеличение производительности
по отношению к включённому профилированию
В начале производительность хорошая и задержки небольшие, но стоит процессору забиться
как всё падает и даже если нагрузка немного спадает - улучшения не наблюдается
12:16
запуск с профайлингом на 400 соединений
проц не загружен под завязку, примерно на 60%
однако даже так производительность ниже по tps
задержка таки больше, но хотя бы нет резкого падения
так как нет упора в 100 его не тротлит вообще
14:02
отрубил балансировку irq на процы мои и поставил все разрешённые cpu ручками
однако улучшений вообще не видать
11-34-32
просто запуск на 400 клиентов без трасировки ПОСМОТРЮ КАК ПРОИЗВОДИТЕЛЬНОСТЬ МЕНЯЕТСЯ ОТ ЗАГРУЗКИ
15:53
запуск 100 клиенов с отслеживанием нагрузки на cpu буду увеличивать до падения жуткого
16:44
то же, только вывод переделал
16:48
ошибка по времени перезапуск
17:04
на 200 клиентов
17:21
на 300
17:40
на 400
17:52
на 500
##TODO: попробовать отключить cfs квоты для группы моей, она же уже посажена на процессоры определённые
а тут её ещё планировщик дёргает постоянно
18:05
на 600
22:03
попытаюсь отключит квоту по cpu для контейнера и посмотрю что изменится
вроде не особо чего изменилось. пока изоляция лучше по всем параметрам
22:26
запустил сканирование потребления цпу на 800 с отключенными квотами
писаться будет в тот же файл что и 100-1000
в принципе происходит всё то же самое, только счётчик тротлинга не тикает
надо снять полные показания
22:39
на 400 профайлинг полный с отключённой cpuquota
16:22
попытался поставить большие страницы
то ли они не работают, то ли чего, но производительность не увеличилась
